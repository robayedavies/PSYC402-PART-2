---
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, echo=FALSE}
library(broom)
library(gridExtra)
library(lme4)
library(tidyverse)
```

```{r readin, echo=FALSE}
long.all.noNAs <- read_csv("long.all.noNAs.csv", 
                  col_types = cols(
                    subjectID = col_factor(),
                    item_name = col_factor()
                    )
                  )
```

> Rob Davies

# PSYC402 Part 2 Week 18

## Welcome

Welcome to our overview of the materials and guidance you will work with in **PSYC402 Week 18** for the **02-mixed** class.

This week, we again look at data with multilevel structure.
But we now look at data where participants were asked to respond to a set of stimuli (words) so that our observations consist of recordings of the response made by each participant to each stimulus.
We use the same analysis procedure that we used for multilevel data: with one significant change which we shall identify and explain.

In this webpage, I extract and present an outline taster summary (a little re-ordered) of a second chapter written for the course.
Please go to the chapter for the full text: [02-mixed.pdf](files/week-18/02-mixed.pdf).

### Introductory discussion

Many psychological studies involve scenarios in which the researcher samples both participants and some kind of stimulus (e.g., words, pictures, sounds, stories ...)
Often, the researcher will present the stimuli to the participants for response in some version of a range of possible designs: 

- all participants see and respond to all stimuli; 
- participants respond to different sub-sets of stimuli in different conditions (or in different groups) but they see and respond to all stimuli in a sub-set; 
- participants are allocated to respond to stimulus sub-sets according to a counter balancing scheme (e.g., through the use of Latin squares).

We are talking, here, about **repeated-measures designs** where the experimenter presents a sample of multiple stimuli for response to each participant in a sample of multiple participants.

Whatever version of this scenario, *if* participants are responding to multiple stimuli and *if* multiple participants respond to each stimulus, then the data will have a *multilevel structure* such that each observation can be grouped both by participant and by stimulus.
We could say that observations of the responses made by participants to each stimulus can be grouped by participant: each person will tend to respond in similar ways to different stimuli; and we will see differences between participants.
Or, we could say that observations of responses can be grouped by stimulus because each stimulus will tend to evoke similar kinds of responses in different people; and we will see differences between the responses made to different stimuli.
The differences between the sets (or groups) of responses made by different participants (between participants differences) and the differences between the sets of responses made to different stimuli (between stimulus differences) may be unexplained or random differences.

**The multilevel structure requires that we use multilevel or mixed-effects models to analyse our data.**
We are going to learn about an approach in which we take into account the unexplained or random differences between participants *and* between stimuli.
A substantial portion of our conceptual development will now begin, with a deepening in our perspective on the impact of random differences between participants or stimuli, which we shall discuss in terms of *random effects*.
We shall extend our practical skills by learning how to specify these random effects in different ways using the `lmer()` function.

We will learn to fit models that can effectively handle the fact that we may observe responses from participants who not only differ in their average level of performance (differ in intercepts, if we control for the effects of covariates) but differ also in their response to experimental variables (differ in slopes).
Our work, here, will build on the work we did in the previous class.
Figure \@ref(fig:freqperchildlm) presents estimates of the intercept and the effect of an experimental variable (word frequency) for each participant in our example dataset, with plot points shown ordered by the size of the estimate.

```{r freqperchildlm, echo=FALSE, fig.cap = 'Estimated intercepts and frequency effect slopes (with SEs) calculated for each child analysed separately, with point estimates presented in order of size', warning=FALSE, message=FALSE, out.width='95%', fig.width=9,fig.height=4}

# plot intercept and lm frequency coefficient for each child, data considered separately
 
freqperchildlm <- long.all.noNAs %>%
                  group_by(subjectID) %>% 
                  do(tidy(lm(RT ~ Lg.UK.CDcount, data=.)))

freqperchildlm$term <- as.factor(freqperchildlm$term)

freqperchildlmint <- filter(freqperchildlm, term == '(Intercept)')
freqperchildlmfreq <- filter(freqperchildlm, term == 'Lg.UK.CDcount')

pfreqperchildlmint <- freqperchildlmint %>%
ggplot(aes(x = fct_reorder(subjectID, estimate), y = estimate, ymin = estimate - std.error, ymax = estimate + std.error)) + 
  geom_point() + geom_linerange() + 
  theme_bw() + 
  xlab("Intercepts in order of size") +
  ylab("Estimated intercept +/- SE") + 
  theme(axis.title.y = element_text(size = 10), axis.text.y = element_text(size = 5), axis.text.x = element_blank(), panel.grid = element_blank())

pfreqperchildlmfreq <- freqperchildlmfreq %>%
ggplot(aes(x = fct_reorder(subjectID, estimate), y = estimate, ymin = estimate - std.error, ymax = estimate + std.error)) + 
  geom_point() + geom_linerange() + 
  theme_bw() + 
  xlab("Frequency effect coefficient in order of size") +
  ylab("Estimated coefficient for the frequency effect +/- SE") + 
  theme(axis.title.y = element_text(size = 10), axis.text.y = element_text(size = 5), axis.text.x = element_blank(), panel.grid = element_blank())
 
grid.arrange(pfreqperchildlmint, pfreqperchildlmfreq,
             ncol = 2) 
 
```

We will learn to fit models that can *also* handle the fact that, as is often true in psychological research, we may observe responses that are made to stimuli which will present random differences as well (in relative difficulty, say).
For example, some words elicit slower and some elicit faster responses on average (Figure \@ref(fig:pitemsints)).

```{r pitemsints, fig.cap = 'Estimated intercepts (with SEs) calculated for each stimulus word, with coefficients ordered by average latency for each word', echo=FALSE, warning=FALSE, message=FALSE, fig.height=4, fig.width=9, out.width = '100%'}

# what about variation between items in intercepts?
# -- for each itemname, plots ordered by meanRT

# create a model for each item, including just the intercept

wperitemlm <- long.all.noNAs %>% 
              group_by(item_name) %>% 
              do(tidy(lm(RT ~ 1, data=.)))
wperitemlm$term <- as.factor(wperitemlm$term)
# wperitemlm

# plot intercepts by-items -- ordering items by item_name by estimated intercept size

pwperitemlmint <- ggplot(wperitemlm, aes(x = fct_reorder(item_name, estimate), y = estimate, ymin = estimate - std.error, ymax = estimate + std.error))
pwperitemlmint + geom_point() + geom_linerange() + 
  theme_bw() + ylab("Estimated coefficient +/- SE") + xlab("Per-item estimates of intercept, ordered by intercept estimate size") +
  theme(axis.title.y = element_text(size = 10), axis.text.y = element_text(size = 5), axis.text.x = element_blank(), panel.grid = element_blank())

```

In a further extension of our understanding, located especially in the chapter reading, we will develop our conceptual grasp of multilevel or mixed effects models by considering carefully what we estimate when we estimate random effects.
We will discuss the ways in which the random effects structure of multilevel or mixed-effects models can vary, and what impact that variation may have, as illustrated in Figure \@ref(fig:indiv-prediction).

```{r indiv-prediction, fig.cap = 'Plot showing model predictions of the effect, for each individual, of word frequency on reading reaction time -- predictions vary between models incorporating (a.) random effect of participants on intercepts only; (b.) random effect of participants on slopes only and (c.) random effect of participants on intercepts and on slopes', echo=FALSE, warning=FALSE, message=FALSE, fig.height=4.5, fig.width=9, out.width = '100%'}

# -- fit an lmer -- different kinds

lmer.all.1 <- lmer(RT ~  Lg.UK.CDcount + (Lg.UK.CDcount + 1||subjectID),
                   
                   data = long.all.noNAs)

# summary(lmer.all.1)

lmer.all.2 <- lmer(RT ~  Lg.UK.CDcount + (1|subjectID),
                   
                   data = long.all.noNAs)

# summary(lmer.all.2)

lmer.all.3 <- lmer(RT ~  Lg.UK.CDcount + (Lg.UK.CDcount + 0|subjectID),
                   
                   data = long.all.noNAs)

# summary(lmer.all.3)

# -- plot random effect -- per person predictions
# https://bbolker.github.io/morelia_2018/notes/mixedlab.html
# In lmer, predict has a re.form argument that specifies which random effects should 
# be included (NA or ~0=none, population level; NULL (=all) or ~subject=prediction at 
# the subject level; more complex models, might have additional nested levels).

long.all.noNAs$pred1 <- predict(lmer.all.1) ## individual level
long.all.noNAs$pred2 <- predict(lmer.all.2) ## individual level
long.all.noNAs$pred3 <- predict(lmer.all.3) ## individual level

p.slopes.intercepts <- long.all.noNAs %>%
ggplot(aes(x = Lg.UK.CDcount, y = RT)) +
  geom_point(alpha = .25, colour = "darkgrey") +
  geom_line(aes(y = pred1, group = subjectID), colour="red", alpha = .4) +
  ggtitle("(c.)\n(Lg.UK.CDcount + 1||subjectID)") +
  xlab("Frequency (Lg.UK.CDcount)") +
  xlim(0,5) +
  theme_bw()

p.intercepts <- long.all.noNAs %>%
  ggplot(aes(x = Lg.UK.CDcount, y = RT)) +
  geom_point(alpha = .25, colour = "darkgrey") +
  geom_line(aes(y = pred2, group = subjectID), colour="red", alpha = .4) +
  ggtitle("(a.)\n(1|subjectID)") +
  xlab("Frequency (Lg.UK.CDcount)") +
  xlim(0,5) +
  theme_bw()

p.slopes <- long.all.noNAs %>%
  ggplot(aes(x = Lg.UK.CDcount, y = RT)) +
  geom_point(alpha = .25, colour = "darkgrey") +
  geom_line(aes(y = pred3, group = subjectID), colour="red", alpha = .4) +
  ggtitle("(b.)\n(Lg.UK.CDcount + 0|subjectID)") +
  xlab("Frequency (Lg.UK.CDcount)") +
  xlim(0,5) +
  theme_bw()

grid.arrange(p.intercepts, p.slopes, p.slopes.intercepts, 
             ncol = 3
             )

```

### Critical idea

The critical idea is that, in general, in experimental psychological science, when we do data analysis, *if* we want to estimate effects of experimental variables more accurately *then* our models need to incorporate terms to capture the impact on observed outcomes of variation among sampled participants and among sampled stimuli.
Historically, we have, as a field, learned that we must take these sampling effects into account.
More and more commonly, we are learning to use multilevel or mixed-effects models to do this.

### Targets

Our learning objectives include the development of key concepts and skills.

- **concepts** --	begin to develop an understanding of crossed random effects of subjects and stimuli
- **skills** -- practice how to tidy experimental data for mixed-effects analysis
- **skills** -- practice fitting linear mixed-effects models incorporating random effects of subjects and stimuli

Our aim is to build on our development of understanding and skills.
The critical extension, here, is to take the perspective in which we are not just grouping observations under only one kind of grouping (e.g., children's scores, grouped by class) but are working with analyses which allow us to take into account the fact that we have data -- as happens for many studies -- where observations are structured both by participants and by stimuli.

## Resources for you

You will see -- below -- links to the lectures, information about the data we will analyze, and an explanation of the activities.

The links and everything you need for your practical work class can *also* be found in the **Week 16 files** folder on Moodle, here:

[Link to Moodle](https://modules.lancaster.ac.uk/course/view.php?id=34085#section-10){target="_blank"}

Our aim is to get started in our development of understanding how to use multilevel of mixed-effects models: we need to learn what they are, when and why they are needed, and how they should be used.

I have prepared materials that I suggest you use in this order:

- **Before the lab session**

1. Take a look at the lecture slides, watch the lecture video. The lecture is designed to work *only* as an outline summary of the materials. Learning will work best if you read the book chapter I wrote on the topic, and work through the exercises in the workbook.R
2. Read the book chapter, at least up to p.11, to get an outline view on the answers to the what, why, when and how questions on multilevel models.
2. Download the week 16 files, and work your way throught the workbook.R, guided by the book chapter, at least as far as reading in the data and tidying it for analysis.

- **In the session**

3. Work through the workbook.R, complete the tasks and answer the questions, in groups, guided by the code tips and the information in the chapter.

- **After the session**

4. Bring your questions to the Q&A session or post questions to the discussion forum.

Be patient with yourself and with the materials. The topic is challenging because it is new but it is very important. The plan is to build up understanding and analysis skill step by step.

### Lectures: video recordings

The lecture material for this week is presented in three parts.
Click on a link and your browser should open a tab showing the *Panopto* video for the lecture part.
(You will need to be on campus or logged in to the university VPN to get access to the videos.)

[Part 1 of 3](https://dtu-panopto.lancs.ac.uk/Panopto/Pages/Viewer.aspx?id=2fa60b12-2eca-4412-8672-acd60104da1d){target="_blank"}

[Part 2 of 3](https://dtu-panopto.lancs.ac.uk/Panopto/Pages/Viewer.aspx?id=7f31cef0-1e39-4712-b2a1-acd601195c78){target="_blank"}

[Part 3 of 3](https://dtu-panopto.lancs.ac.uk/Panopto/Pages/Viewer.aspx?id=58ab0c0c-37be-491f-a9e5-acd6011c38dd){target="_blank"}

### Book chapter

I wrote a book chapter to support PSYC402 student learning.

You can download the chapter here [02-mixed.pdf](files/week-18/02-mixed.pdf).

### Pre-lab activity 1: Get your files ready for the lab class

Activities in the class that goes with this chapter are associated with the following data files:

- `CP study word naming rt 180211.dat`
- `CP study word naming acc 180211.dat`
- `words.items.5 120714 150916.csv`
- `all.subjects 110614-050316-290518.csv`

And the .R code file:

- `402-02-mixed-effects-workbook.R`

A pre-tidied version of the CP study data is available as:

- `long.all.noNAs.csv`

You will use `402-02-mixed-effects-workbook.R` in the lab activity.

### Lab activity

We will take things step-by-step.
We will split .R scripts into parts, tasks and questions:  

- different parts for different phases of the analysis workflow;
- different tasks for different steps in each phase;
- different questions to examine different ideas or coding steps.

### Tasks

In the activity, we are going to work through the following tasks.

1. Load the libraries we need for the exercises
2. Read in the data file we will be using: `BAFACALO_DATASET.RData`
3. We start by selecting the variables we want -- using `select()`
4. Take missing values out of the brazil data -- using `na.omit()`
5. Get R to treat a variable as a type object of the kind required -- using the `as.numeric()` or `as.factor()` functions
6. Experiment with variable coercion
7. Visualize the relationship between portuguese and english grades using a scatterplot
8. Work on editing plots
9. Analyze the relationship between english and portuguese grades in the brazil data -- using `lm()`
10. Exercise: adapt the `lm()` code to do a different analysis
11. Plot the relationship between english and portuguese grades separately for each class using `facet_wrap`
12. Practice your `facet_wrap()` skills
13. Run a linear mixed-effects analysis of the relationship between english and portuguese grades using `lmer()`
14. Exercise mixed-effects model coding

There are some extension exercises you can use to develop your coding skills.

### The data we will work with: Brazilian school children

We will be working with data taken from a study on education outcomes in Brazilian children, reported by Golina and Gomes (2014).
The `BAFACALO_DATASET.RData` data were collected and shared online by Golina and Gomes (2014). 
Information about the background motivating the study, the methods of data collection, along with the dataset itself, can be found in the book chapter, and at the data journal article:

[Golina and Gomes (2014) article](https://openpsychologydata.metajnl.com/articles/10.5334/jopd.af/){target="_blank"}

## References

Golino, H. F., & Gomes, C. M. A. (2014). Psychology data from the “BAFACALO project: The Brazilian Intelligence Battery based on two state-of-the-art models – Carroll’s Model and the CHC model”. *Journal of Open Psychology Data*, 2(1), e6. DOI: http://doi.org/10.5334/jopd.af
